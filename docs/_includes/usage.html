<div class="wrapper">
<aside class="usage__nav">
<nav>
<ol>
<li class="nav__item">
      <a rel="instructions" 
         href="#packages/core/usage/apm.usage.mdx" 
         title="Setting up APM using console.">Console APM</a>
    </li>
<li class="nav__item">
      <a rel="instructions" 
         href="#packages/core/usage/log.usage.mdx" 
         title="Configure logging">Logging</a>
    </li>
<li class="nav__item">
      <a rel="instructions" 
         href="#packages/node/usage/apm.usage.mdx" 
         title="Setting up APM for Node.js applications.">APM Support for Node</a>
    </li>
</ol>
</nav>
</aside>
<main class="usage"><section id="packages/core/usage/apm.usage.mdx" class="usage__example">
<a class="usage__title" href="#packages/core/usage/apm.usage.mdx" rel="section"><h2>Console APM</h2></a>
<!-- description=Setting up APM using console. (packages/core/usage/apm.usage.mdx) --><p>Console has a built in <code>console.time()</code> and <code>console.count()</code>. These can be setup with the <a href="https://btilford.github.io/ts-base/api/globals.html#console_apm">CONSOLE_APM</a>
configuration.</p>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> {expect} <span class="hljs-keyword">from</span> <span class="hljs-string">'chai'</span>;
<span class="hljs-keyword">import</span> {
  bootstrap,
  CONSOLE_APM,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;

<span class="hljs-keyword">const</span> appName = <span class="hljs-string">'my-app'</span>;
bootstrap({
  appName,
  apm: CONSOLE_APM,
});
</code></pre>
<h3 id="annotating-methods-with-decorators">Annotating methods with decorators <a class="header-anchor" href="#annotating-methods-with-decorators">¶</a></h3>
<p>There are method decorators for counters, timers, and gauges to capture metrics around their
execution.</p>
<h4 id="counters">Counters <a class="header-anchor" href="#counters">¶</a></h4>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> {
  CountErrors,
  CountInvocations,
  CountSuccess,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;

<span class="hljs-keyword">class</span> Example {
    <span class="hljs-meta">@CountInvocations</span>()
    <span class="hljs-meta">@CountSuccess</span>()
    <span class="hljs-meta">@CountErrors</span>()
    method() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Called'</span>);
    }
}

</code></pre>
<h4 id="gauges">Gauges <a class="header-anchor" href="#gauges">¶</a></h4>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> {
  GaugeErrors,
  GaugeInvocations,
  GaugeSuccess,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;

<span class="hljs-keyword">class</span> Example {
    <span class="hljs-meta">@GaugeInvocations</span>()
    <span class="hljs-meta">@GaugeSuccess</span>()
    <span class="hljs-meta">@GaugeErrors</span>()
    method() {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Called'</span>);
    }
}

</code></pre>
<h4 id="timers">Timers <a class="header-anchor" href="#timers">¶</a></h4>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> {
  Timed,
  TimedAsync,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;

<span class="hljs-keyword">class</span> Example {
    <span class="hljs-meta">@Timed</span>()
    method(): <span class="hljs-built_in">void</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Called sync'</span>);
    }

    <span class="hljs-meta">@TimedAsync</span>()
    <span class="hljs-keyword">async</span> methodAsync(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Called async'</span>);
    }

}

</code></pre>

</section><section id="packages/core/usage/log.usage.mdx" class="usage__example">
<a class="usage__title" href="#packages/core/usage/log.usage.mdx" rel="section"><h2>Logging</h2></a>
<!-- description=Configure logging (packages/core/usage/log.usage.mdx) --><h3 id="console-log">Console Log <a class="header-anchor" href="#console-log">¶</a></h3>
<p>This is a wrapper around console but supports all the logging features like interceptors, message templates,
and context suppliers.</p>
<p>You can create one pretty simply.</p>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> {ConsoleLog} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;

<span class="hljs-keyword">const</span> log = ConsoleLog.create({name:<span class="hljs-string">'my-log'</span>});

log.info(<span class="hljs-string">'Hello'</span>);
</code></pre>
<p>You can also register a root logger and configure the default log level when bootstrapping.</p>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> {
    ConsoleLog,
    bootstrap,
    LogLevel,
    LogConfig,
    templateString,
    Providers,
    Log,
    loadEnvWithObj,
    LOG_ENV,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;

<span class="hljs-keyword">const</span> appName = <span class="hljs-string">'my-app'</span>;

<span class="hljs-keyword">const</span> config = LogConfig.create({
    rootLevel: LogLevel.WARN,
    messageTemplate: templateString(<span class="hljs-string">'[${ctx.data.fqn}] ${ctx.message}'</span>)
});
<span class="hljs-keyword">const</span> root = ConsoleLog.create({
    name:appName,
    config,
});
bootstrap({
    appName,
    log: {
        root,
    }
});

<span class="hljs-keyword">const</span> log = Providers.provide(Log).extend(<span class="hljs-string">'sub-log'</span>);
<span class="hljs-built_in">console</span>.assert(log.logLevelEnabled(LogLevel.WARN), <span class="hljs-string">'WARN should be enabled'</span>);
<span class="hljs-built_in">console</span>.assert(log.logLevelEnabled(LogLevel.INFO) === <span class="hljs-literal">false</span>, <span class="hljs-string">'INFO should not be enabled'</span>);

log.info(<span class="hljs-string">'Hello world'</span>); <span class="hljs-comment">// no output</span>
log.warn(<span class="hljs-string">'Goodbye'</span>); <span class="hljs-comment">// outputs "[my-app.sub-log] Goodbye"</span>
</code></pre>
<div class="example__output">
<em>stderr&nbsp;&gt;</em>
<br>
<pre><code class="usage__code-block language-shell"><span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">[my-app.sub-log] Goodbye</span></span>
</code></pre>
</div><div class="example__output">
<em>stdout&nbsp;&gt;</em>
<br>
<pre><code class="language-shell"><span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stdout">my-log: Hello</span></span></code></pre>
</div>
</section><section id="packages/node/usage/apm.usage.mdx" class="usage__example">
<a class="usage__title" href="#packages/node/usage/apm.usage.mdx" rel="section"><h2>APM Support for Node</h2></a>
<!-- description=Setting up APM for Node.js applications. (packages/node/usage/apm.usage.mdx) --><h3 id="configuring-apm-in-node">Configuring APM in Node <a class="header-anchor" href="#configuring-apm-in-node">¶</a></h3>
<p>Currently you have 2 main options, either Prometheus or StatsD. Both support counters, gauges, timers,
and histograms.</p>
<h4 id="prometheus">Prometheus <a class="header-anchor" href="#prometheus">¶</a></h4>
<p>The Prometheus integration is done with <a href="https://github.com/siimon/prom-client/">prom-client</a> which has
a lot of already built in and automated metrics or integrations.</p>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> { bootstrap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@btilford/ts-base'</span>;
<span class="hljs-keyword">import</span> {createPrometheusFeature, PromOptions} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;
<span class="hljs-keyword">import</span> {Registry} <span class="hljs-keyword">from</span> <span class="hljs-string">'prom-client'</span>;

<span class="hljs-keyword">const</span> appName = <span class="hljs-string">'my-app'</span>;
<span class="hljs-keyword">const</span> registry = <span class="hljs-keyword">new</span> Registry();

<span class="hljs-keyword">const</span> options: PromOptions = {
    registry,
    help: <span class="hljs-string">''</span>,
    tags: {appName, example:<span class="hljs-string">'true'</span>}
};
bootstrap({
    appName,
    <span class="hljs-comment">// Make the prometheus Registry available by calling Providers.provider(Registry)</span>
    register: [[registry, Registry]],
    apm: {
        features: {
            counter: createPrometheusFeature({
                name:<span class="hljs-string">'counter'</span>,
                prefix:appName,
                options
            }),
            gauge: createPrometheusFeature({
                name:<span class="hljs-string">'gauge'</span>,
                prefix:appName,
                options
            }),
            timer: createPrometheusFeature({
                name:<span class="hljs-string">'timer'</span>,
                prefix:appName,
                options
            }),
            histogram: createPrometheusFeature({
                name:<span class="hljs-string">'histogram'</span>,
                prefix:appName,
                options
            }),
        }
    }
});

</code></pre>
<div class="example__output">
<em>stderr&nbsp;&gt;</em>
<br>
<pre><code class="usage__code-block language-shell"><span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">internal/modules/cjs/loader.js:323</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">      throw err;</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">      ^</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">Error: Cannot find module &#39;/home/btilford/work/btilford/tshed/packages/node/node_modules/@btilford/ts-base/dist/index.js&#39;. Please verify that the package.json has a valid &quot;main&quot; entry</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at tryPackage (internal/modules/cjs/loader.js:315:19)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Function.Module._findPath (internal/modules/cjs/loader.js:703:18)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:967:27)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Function.Module._load (internal/modules/cjs/loader.js:862:27)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Module.require (internal/modules/cjs/loader.js:1040:19)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at require (internal/modules/cjs/helpers.js:72:18)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Object.&lt;anonymous&gt; (/home/btilford/work/btilford/tshed/packages/node/.usage/.usage/apm.usage.mdx_13.js:3:19)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Module._compile (internal/modules/cjs/loader.js:1151:30)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1171:10)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Module.load (internal/modules/cjs/loader.js:1000:32) {</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">  code: &#39;MODULE_NOT_FOUND&#39;,</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">  path: &#39;/home/btilford/work/btilford/tshed/packages/node/node_modules/@btilford/ts-base/package.json&#39;,</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">  requestPath: &#39;@btilford/ts-base&#39;</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">}</span></span>
</code></pre>
</div><h4 id="statsd">StatsD <a class="header-anchor" href="#statsd">¶</a></h4>
<p>The StatsD integration uses <a href="https://github.com/brightcove/hot-shots/">hot-shots</a> StatsD client which
supports extended StatsD features used by Telegraf and Datadog. There are a lot of framework integrations
and automated capture you can configure with StatsD.</p>
<p>There is also an <em>Log interceptor</em> that can send events to Datadog.</p>
<pre><code class="usage__code-block language-typescript"><span class="hljs-keyword">import</span> { bootstrap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@btilford/ts-base'</span>;
<span class="hljs-keyword">import</span> {createStatsDFeature, StatsDOptions} <span class="hljs-keyword">from</span> <span class="hljs-string">'../src'</span>;
<span class="hljs-keyword">import</span> {Registry} <span class="hljs-keyword">from</span> <span class="hljs-string">'prom-client'</span>;

<span class="hljs-keyword">const</span> appName = <span class="hljs-string">'my-app'</span>;
<span class="hljs-keyword">const</span> options: StatsDOptions = {
    prefix: appName,
    sampleRate: <span class="hljs-number">0.8</span>,
    tags: {appName, example:<span class="hljs-string">'true'</span>},
};
bootstrap({
    appName,
    apm: {
        features: {
            counter: createStatsDFeature({
                name:<span class="hljs-string">'counter'</span>,
                options
            }),
            gauge: createStatsDFeature({
                name:<span class="hljs-string">'gauge'</span>,
                options
            }),
            timer: createStatsDFeature({
                name:<span class="hljs-string">'timer'</span>,
                options
            }),
            histogram: createStatsDFeature({
                name:<span class="hljs-string">'histogram'</span>,
                options
            }),
        }
    }
});
</code></pre>
<div class="example__output">
<em>stderr&nbsp;&gt;</em>
<br>
<pre><code class="usage__code-block language-shell"><span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">internal/modules/cjs/loader.js:323</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">      throw err;</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">      ^</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">Error: Cannot find module &#39;/home/btilford/work/btilford/tshed/packages/node/node_modules/@btilford/ts-base/dist/index.js&#39;. Please verify that the package.json has a valid &quot;main&quot; entry</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at tryPackage (internal/modules/cjs/loader.js:315:19)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Function.Module._findPath (internal/modules/cjs/loader.js:703:18)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:967:27)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Function.Module._load (internal/modules/cjs/loader.js:862:27)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Module.require (internal/modules/cjs/loader.js:1040:19)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at require (internal/modules/cjs/helpers.js:72:18)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Object.&lt;anonymous&gt; (/home/btilford/work/btilford/tshed/packages/node/.usage/.usage/apm.usage.mdx_23.js:3:19)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Module._compile (internal/modules/cjs/loader.js:1151:30)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1171:10)</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">    at Module.load (internal/modules/cjs/loader.js:1000:32) {</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">  code: &#39;MODULE_NOT_FOUND&#39;,</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">  path: &#39;/home/btilford/work/btilford/tshed/packages/node/node_modules/@btilford/ts-base/package.json&#39;,</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">  requestPath: &#39;@btilford/ts-base&#39;</span></span>
<span class="hljs-meta">&gt; </span><span class="hljs-bash shell"><span class="hljs-string stderr">}</span></span>
</code></pre>
</div>
</section>
</main>
</div>